name: Enforce Folder Naming (No Colon)

on:
  push:
    branches: [ main, master ]

permissions:
  contents: write

jobs:
  enforce:
    runs-on: ubuntu-latest

    # ðŸ”’ Prevent infinite loop
    if: |
      !contains(github.event.head_commit.message, 'Auto-fix folder names')

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Detect and fix colon folders
        run: |
          set -e
          TIMESTAMP=$(date +"%Y%m%d_%H%M%S")
          CHANGED=false

          # Scan entire repo
          while IFS= read -r DIR; do
            CLEAN="${DIR%:}"
            TARGET="$CLEAN"

            if [ -d "$TARGET" ]; then
              TARGET="${CLEAN}_${TIMESTAMP}"
            fi

            echo "Fixing: $DIR -> $TARGET"
            mv "$DIR" "$TARGET"
            CHANGED=true
          done < <(find . -type d -name '*:')

          if [ "$CHANGED" = true ]; then
            git config user.name "github-actions[bot]"
            git config user.email "github-actions@users.noreply.github.com"
            git add -A
            git commit -m "Auto-fix folder names (remove colon)"
            git push
          else
            echo "Repo is clean. No action needed."
          fi
